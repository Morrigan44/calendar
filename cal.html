<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SL Calendar Display</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #202020; color: #fff; }
    ul { list-style: none; padding: 0; }
    li { padding: 4px 0; border-bottom: 1px solid #444; }
    .time { font-weight: bold; margin-right: 8px; }
    .error { color: #f88; padding: 8px; }
  </style>
</head>
<body>
  <h3 style="margin:8px;">
    Events for <span id="dayLabel">…</span>
  </h3>
  <ul id="events"></ul>
  <div id="err" class="error"></div>

  <script>
    const CAL_ID_RAW = 'wgnews10@gmail.com';
    const CAL_ID     = encodeURIComponent(CAL_ID_RAW);
    const API_KEY    = 'AIzaSyAAhKKZtAqK4LNj0V6od_HbwWGltuei_oY';
    const MAX_EVENTS = 10;

    function getOffset() {
      const n = parseInt(new URLSearchParams(location.search).get('offset'), 10);
      return isNaN(n) ? 0 : n;
    }

    function getWindow(offset) {
      const start = new Date();
      start.setHours(0,0,0,0);
      start.setDate(start.getDate() + offset);
      const end = new Date(start);
      end.setHours(23,59,59,999);
      return {
        timeMin: start.toISOString(),
        timeMax: end.toISOString(),
        label:   start.toDateString()
      };
    }

    (function(){
      const offset = getOffset();
      const { timeMin, timeMax, label } = getWindow(offset);
      document.getElementById('dayLabel').textContent = label;

      // Build the full URL
      const url = `https://www.googleapis.com/calendar/v3/calendars/${CAL_ID}/events?` +
        new URLSearchParams({
          key:         API_KEY,
          timeMin,
          timeMax,
          maxResults:  MAX_EVENTS,
          singleEvents:true,
          orderBy:     'startTime'
        });

      // Debug: show URL in console
      console.log('Fetching:', url);

      fetch(url)
        .then(res => {
          // Clone the response to inspect JSON even on error
          return res.json()
            .then(json => {
              if (!res.ok) {
                const msg = (json.error && json.error.message) || `HTTP ${res.status}`;
                throw new Error(msg);
              }
              return json;
            });
        })
        .then(data => {
          const ul = document.getElementById('events');
          if (!data.items || data.items.length === 0) {
            ul.innerHTML = '<li>No events.</li>';
            return;
          }
          data.items.forEach(ev => {
            const start = new Date(ev.start.dateTime || ev.start.date)
                            .toLocaleTimeString();
            const li = document.createElement('li');
            li.innerHTML = `<span class="time">${start}</span>${ev.summary}`;
            ul.appendChild(li);
          });
        })
        .catch(err => {
          // Show error on page and console
          document.getElementById('err').textContent = `Error: ${err.message}`;
          console.error('Calendar API error →', err);
        });
    })();
  </script>
</body>
</html>
